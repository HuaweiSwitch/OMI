#!/bin/sh
##==============================================================================
##
## This file was generated by ./configure
##
##==============================================================================

##
## Check options
##

for opt
do

  arg=`expr "x$opt" : 'x[^=]*=\(.*\)'`

  case $opt in

    -h | --help)
      help=1
      ;;

    --destdir=*)
      destdir=$arg
      ;;

    --openssllibdir=*)
      openssllibdir=$arg
      if [ ! -d "/usr/lib" ]; then
        echo "$0: directory given by --openssllibdir option does not exist: "
        exit 1
      fi
      ;;

    *)
      echo "$0: unknown option:  $opt"
      exit 1
      ;;

  esac
done

if [ -z "$destdir" ]; then
  destdir=/
fi

##
## Print help message
##

if [ "$help" = "1" ]; then
cat<<ENDHELP

Usage: ./install [OPTIONS]

OVERVIEW:

This script installs OMI.

    $ ./install --destdir /opt

OPTIONS:
    -h, --help              Print this help message.
    --destdir=PATH          Install under PATH (default=/)

ENDHELP
    exit 0
fi

##
## Find openssl program.
##

if [ ! -x "`which openssl`" ]; then
    echo "$0: 'openssl' program not found on path. Please add to path an try again".
    exit 1
fi

##
## Attempt to resolve OpenSSL libdir.
##

openssllibdir=`/home/test/omi-1.0.8/buildtool openssllibdir `

if [ -n "$openssllibdir" ]; then
    LD_LIBRARY_PATH=$openssllibdir
    export LD_LIBRARY_PATH
fi

openssl -h > /dev/null 2> /dev/null

if [ "$?" != "0" ]; then
    echo "$0: openssl program is not executable."
    exit 1
fi

##
## Create directories.
##

mkdir -p $destdir//opt/omi-1.0.8
mkdir -p $destdir//opt/omi-1.0.8/bin
mkdir -p $destdir//opt/omi-1.0.8/lib
mkdir -p $destdir//opt/omi-1.0.8/var
mkdir -p $destdir//opt/omi-1.0.8/var/log
mkdir -p $destdir//opt/omi-1.0.8/var/run
mkdir -p $destdir//opt/omi-1.0.8/etc
mkdir -p $destdir//opt/omi-1.0.8/lib
mkdir -p $destdir//opt/omi-1.0.8/etc/ssl/certs
mkdir -p $destdir//opt/omi-1.0.8/var/omiauth
mkdir -p $destdir//opt/omi-1.0.8/include
mkdir -p $destdir//opt/omi-1.0.8/include/micxx
mkdir -p $destdir//opt/omi-1.0.8/include/omiclient
mkdir -p $destdir//opt/omi-1.0.8/share
mkdir -p $destdir//opt/omi-1.0.8/share/omischema
mkdir -p $destdir//opt/omi-1.0.8/etc/omiregister
mkdir -p $destdir//opt/omi-1.0.8/etc/omiregister/interop
mkdir -p "$destdir//opt/omi-1.0.8/etc/omiregister/root-cimv2"
mkdir -p "$destdir//opt/omi-1.0.8/etc/omiregister/root-omi"
mkdir -p "$destdir//opt/omi-1.0.8/etc/omiregister/root-check"
mkdir -p $destdir//opt/omi-1.0.8/etc/omiregister/

##
## Install executables.
##

if test -f "./output/bin/omiimage"; then
    cp -f ./output/bin/omiimage $destdir//opt/omi-1.0.8/bin/omiimage
    rm -r $destdir/bin/omiserver
    ln -s $destdir//opt/omi-1.0.8/bin/omiimage $destdir//opt/omi-1.0.8/bin/omiserver
    rm -r $destdir/bin/omiagent
    ln -s $destdir//opt/omi-1.0.8/bin/omiimage $destdir//opt/omi-1.0.8/bin/omiagent
else
    cp -f ./output/bin/omiserver $destdir//opt/omi-1.0.8/bin/omiserver
    cp -f ./output/bin/omiagent $destdir//opt/omi-1.0.8/bin/omiagent
fi

cp -f ./output/bin/omicli $destdir//opt/omi-1.0.8/bin/omicli
cp -f ./output/bin/omigen $destdir//opt/omi-1.0.8/bin/omigen
cp -f ./output/bin/omireg $destdir//opt/omi-1.0.8/bin/omireg
cp -f ./output/bin/omicheck $destdir//opt/omi-1.0.8/bin/omicheck

##
## Install libraries.
##

cp -f ./output/lib/libmicxx.so $destdir//opt/omi-1.0.8/lib/
cp -f ./output/lib/libomiclient.so $destdir//opt/omi-1.0.8/lib/
cp -f ./output/lib/libmi.so $destdir//opt/omi-1.0.8/lib/

if test -f "./output/lib/libbase.so"
then
    cp -f ./output/lib/libbase.so $destdir//opt/omi-1.0.8/lib/
fi

if test -f "./output/lib/libpal.so"
then
    cp -f ./output/lib/libpal.so $destdir//opt/omi-1.0.8/lib/
fi


##
## Install configuration files.
##

if test ! -f "$destdir//opt/omi-1.0.8/etc/omiserver.conf" 
then 
    cp ./etc/omiserver.conf $destdir//opt/omi-1.0.8/etc/omiserver.conf
fi

if test ! -f "$destdir//opt/omi-1.0.8/etc/omicli.conf"
then 
    cp ./etc/omicli.conf $destdir//opt/omi-1.0.8/etc/omicli.conf
fi

if test ! -f "$destdir//opt/omi-1.0.8/etc/omigen.conf"
then 
    cp ./etc/omigen.conf $destdir//opt/omi-1.0.8/etc/omigen.conf
fi

##
## Install header files.
##

cp -f ./output/include/MI.h $destdir//opt/omi-1.0.8/include/
cp -f ./micxx/array.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/context.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/field.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/micxx.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/types.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/arraytraits.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/datetime.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/instance.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/propertyset.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/atomic.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/dinstance.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/linkage.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/micxx_string.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./micxx/atomic.h $destdir//opt/omi-1.0.8/include/micxx/
cp -f ./omiclient/linkage.h $destdir//opt/omi-1.0.8/include/omiclient/
cp -f ./omiclient/client.h $destdir//opt/omi-1.0.8/include/omiclient/
cp -f ./omiclient/handler.h $destdir//opt/omi-1.0.8/include/omiclient/

##
## Install schema files (MOF files).
##

cp -f ./share/omischema/CIM_Schema.mof $destdir//opt/omi-1.0.8/share/omischema/
rm -rf $destdir//opt/omi-1.0.8/share/omischema/CIM-2.32.0
cp -r ./share/omischema/CIM-2.32.0 $destdir//opt/omi-1.0.8/share/omischema/

##
## Install providers.
##

cp -f "./etc/omiregister/root-omi/omiidentify.reg" "$destdir//opt/omi-1.0.8/etc/omiregister/root-omi"
cp -f "./etc/omiregister/root-check/omiidentify.reg" "$destdir//opt/omi-1.0.8/etc/omiregister/root-check"
cp -f ./output/lib/libomiidentify.so $destdir//opt/omi-1.0.8/lib/

##
## Install omi.mak.
##

echo "OMI_ROOT=/" > $destdir//opt/omi-1.0.8/share/omi.mak
cat ./output/omi.mak >> $destdir//opt/omi-1.0.8/share/omi.mak

##
## Install certificates.
##

hostname=P4080RDB
cnffile=./output/ssl.cnf
keyfile=$destdir//opt/omi-1.0.8/etc/ssl/certs/omikey.pem
certfile=$destdir//opt/omi-1.0.8/etc/ssl/certs/omi.pem

if [ -f "$keyfile" -a -f "$certfile" ]; then
  echo
  echo "************************************************************"
  echo "* Warning: The certificate and keyfile were not generated  *"
  echo "* since they already exist.                                *"
  echo "************************************************************"
else
  openssl req -x509 -sha1 -newkey rsa:2048 -days 3650 -nodes -config $cnffile -keyout $keyfile -out $certfile
  chmod 600 $keyfile
  chmod 644 $certfile
fi

##
## Configure PAM.
##

./output/installpam

##
## Install 'uninstall' script.
##

cp ./output/uninstall $destdir//opt/omi-1.0.8/bin/omiuninstall
chmod 755 $destdir//opt/omi-1.0.8/bin/omiuninstall

##
## Print success message!
##

echo "Successfully installed under under: $destdir//opt/omi-1.0.8"

